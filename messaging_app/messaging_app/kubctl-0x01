#!/bin/bash
# kubectl-0x01 - Scale Django app, test load, monitor resources

set -e

# Define your Django deployment name and namespace
DEPLOYMENT_NAME="django"        # change if your deployment has a different name
NAMESPACE="default"             # change if using a different namespace
APP_SERVICE="django-service"    # name of the service exposing your app
REPLICAS=3

echo "Scaling Django deployment to $REPLICAS replicas..."
kubectl scale deployment "$DEPLOYMENT_NAME" --replicas="$REPLICAS" -n "$NAMESPACE"

echo "Waiting for pods to be ready..."
kubectl rollout status deployment "$DEPLOYMENT_NAME" -n "$NAMESPACE"

echo "Listing all pods to verify replicas..."
kubectl get pods -n "$NAMESPACE"

# Wait a few seconds before load testing
sleep 5

# Perform load testing using wrk (replace with correct service URL)
# If using NodePort via Minikube:
SERVICE_URL=$(minikube service "$APP_SERVICE" -n "$NAMESPACE" --url)

echo "Performing load test on $SERVICE_URL..."
wrk -t2 -c10 -d10s "$SERVICE_URL"

# Monitor resource usage
echo "Displaying resource usage of pods..."
kubectl top pods -n "$NAMESPACE"

echo "Script completed!"
